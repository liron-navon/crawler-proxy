{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/fetch/fetch.ts","webpack:///./src/fetch/fetchHTMLWithPuppeteer.ts","webpack:///./src/index.ts","webpack:///./src/routes/index.ts","webpack:///./src/utils/getIP.ts","webpack:///external \"body-parser\"","webpack:///external \"cors\"","webpack:///external \"express\"","webpack:///external \"express-http-proxy\"","webpack:///external \"os\"","webpack:///external \"puppeteer\"","webpack:///external \"request-promise\""],"names":[],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.ts\");\n","import * as requestPromise from 'request-promise';\nimport fetchHTMLWithPuppeteer from './fetchHTMLWithPuppeteer';\n\nconst requestOptions = {\n    // followAllRedirects: true,\n    transform: (body, response, resolveWithFullResponse) => {\n        return {\n            destination: response.request.uri.href,\n            html: body\n        };\n    },\n};\n\nexport const fetchPLAIN = (url: string): Promise<{ html: string, destination: string }> => {\n    return requestPromise({\n        ...requestOptions,\n        url\n    }) as any;\n};\nexport const fetchRENDER = (url: string): Promise<{ html: string, destination: string }> => fetchHTMLWithPuppeteer(url);\n","const puppeteer = require('puppeteer');\n\n// keep the browser alive as a singleton\nlet _browser = null;\n\n// get a new browser page, make sure to call .close() when done with it\nconst getNewPage = async () => {\n    if (!_browser) {\n        _browser = await puppeteer.launch({\n            headless: true,\n            args: ['--no-sandbox']\n        });\n    }\n    return await _browser.newPage();\n};\n\nconst fetch = async (url: string) => {\n    const page = await getNewPage();\n    await page.goto(url, {waitUntil: 'networkidle2'});\n    const html = await page.content();\n    const output = {\n        html,\n        destination: page.url()\n    };\n    await page.close();\n    return output;\n};\n\nexport default fetch;\n\n\n","import * as express from 'express';\nimport * as cors from 'cors';\nimport * as bodyParser from 'body-parser';\nimport routes from './routes';\n\nconst PORT =  process.env.PORT || 3000;\nconst app = express();\n\nprocess.on('uncaughtException', function(err) {\n    console.error( 'UNCAUGHT EXCEPTION', err.stack, err.message );\n});\n\nconst bodyParserOptions = { parameterLimit: 100000, type: 'application/json', limit: 1024 * 1024 * 300 };\n\napp.use(cors());\n\napp.use(bodyParser.json(bodyParserOptions));\napp.use(bodyParser.urlencoded(Object.assign({ extended: false }, bodyParserOptions)));\n\napp.use(function (req, res, next) {\n    const url = req.method + ' - ' + req.protocol + '://' + req.get('host') + req.originalUrl;\n    console.log(url);\n    next();\n});\n\napp.use('/', routes);\n\napp.use(function (err, req, res, next) {\n    console.error(err.stack);\n    res.status(500).send({\n        message: 'something broke!',\n        error: err\n    });\n});\n\napp.listen(PORT, () => console.log(`App listening on port ${PORT}!`));\n","import { Router, Response, Request } from 'express';\nimport { fetchPLAIN, fetchRENDER } from '../fetch/fetch';\nimport * as proxy from 'express-http-proxy';\nimport { getIP } from 'src/utils/getIP';\n\nconst router = Router();\n\nconst getUrlFrom = (identifier, url) => {\n    const index = url.indexOf(identifier) + identifier.length;\n    return url.substr(index);\n};\n\n// proxy to download html and return the final destination\nrouter.get('/crawl-plain/:url*', async (req: Request, res: Response) => {\n    const url = getUrlFrom('/crawl-plain/', req.url);\n    const { destination, html } = await fetchPLAIN(url);\n    console.log('x-final-destination', destination);\n    res.setHeader('x-final-destination', destination);\n    res.send(html);\n});\n\n// proxy ssr\nrouter.get('/crawl-render/:url*', async (req: Request, res: Response) => {\n    const url = getUrlFrom('/crawl-render/', req.url);\n    const { destination, html } = await fetchRENDER(url);\n    console.log('x-final-destination', destination);\n    res.setHeader('x-final-destination', destination);\n    res.send(html);\n});\n\n// if you need a regular proxy\nrouter.get('/proxy', proxy(getIP()));\n\n// if you need a regular on a specific host\nrouter.get('/proxy/:host*', (req, res, next) => {\n    return proxy(req.params.host)(req, res, next);\n});\n\nexport default router;\n","const os = require('os');\nconst ifaces = os.networkInterfaces();\n\n// return the ip for the current computer\nexport const getIP = () => {\n    const ipAddresses = [];\n\n    Object.keys(ifaces).forEach(ifname => {\n        let alias = 0;\n\n        ifaces[ifname].forEach(function (iface) {\n            if ('IPv4' !== iface.family || iface.internal !== false) {\n                // skip over internal (i.e. 127.0.0.1) and non-ipv4 addresses\n                return false;\n            }\n            ipAddresses.push(iface.address);\n            ++alias;\n        });\n    });\n\n    return ipAddresses[0];\n};\n\n","module.exports = require(\"body-parser\");","module.exports = require(\"cors\");","module.exports = require(\"express\");","module.exports = require(\"express-http-proxy\");","module.exports = require(\"os\");","module.exports = require(\"puppeteer\");","module.exports = require(\"request-promise\");"],"sourceRoot":""}